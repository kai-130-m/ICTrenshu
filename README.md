# 日報バックエンド — 指示書（README / 要件定義・方針・タスク：週報→日報 変更反映）

> **目的**: 社内向けの日報アプリについて、現段階で合意しておく最小要件・方針・実装範囲を明文化し、VS Code での作業やレビューを円滑にする。
> **注**: 本文書は指示書であり、プログラム例やSQLは含めない。

---

## 0. スコープ（今やること / 今やらないこと）

* **今やること（MVPたたき台）**

  * Docker Compose で API サーバと DB サーバを起動できる状態を作る。
  * ダミーデータ（日報・ユーザー）を DB に投入できる運用手順を整える（やり直し可能）。
  * 日報をユーザー／日付・期間で一覧・検索できる **READ 専用 API** を 1 本以上公開する。
  * データ品質の最低限の保証（**1ユーザー × 1日 = 1件**）。
* **今やらないこと（後工程）**

  * 認証・認可（SSO/JWT/セッション方式の確定）。
  * 添付、承認フロー、コメント、通知、管理UI などの拡張機能。
  * 深い正規化やレポーティング最適化（ビュー／集計設計）。

---

## 1. 機能要件（Functional Requirements）

### Must（現フェーズで必須）

1. API/DB が Docker Compose で起動・停止できる。
2. ダミーデータを投入・初期化できる運用手順がある（再実行でクリーンにやり直せる）。
3. 日報をユーザー／日付・期間で取得できる READ API がある（上限件数・オフセット等の基本的なページングを備える）。
4. 「1ユーザー × 1日 = 1件」をサーバ側・DB側の両面で守る（重複を防ぐ）。

### Should（次の小さなスライスで）

* 単体取得、作成・更新・削除の最小 API。
* 簡易検索（タイトル・サマリーの部分一致やタグ風のキーワード）。
* 最小の監査（誰が・何を・いつ）。

### Won’t（本番前まで見送り）

* 添付、承認、コメント、通知、RBAC、SSO など。

---

## 2. 非機能要件（Non‑Functional Requirements）

* **可観測性**: ヘルスチェック（DB到達含む）。基本ログは構造化（最低限、時刻・レベル・メッセージ・相関ID）。
* **時刻基準**: DB保存は **UTC**。APIは ISO8601 を返し、UIで **JST 表示**する方針（例外方針は別途整理）。
* **スキーマ運用**: マイグレーションツール（Alembic）で履歴管理。変更は「**前方互換 → コード更新 → 後方削除**」の 3 段階。
* **命名規約**: テーブル/カラムは **snake_case**、真偽は `is_*`、時刻は `*_at`、**日付キーは `report_date`（報告対象の日付）** を推奨。
* **性能の目安**: 通常 100〜200 件程度の一覧を快適に閲覧できる（将来数値厳密化）。

---

## 3. データモデル方針（コードなしの合意事項）
## 3. データモデル方針（コードなしの合意事項）

* **ユーザーの表現**: ユーザーは単一の `users` エンティティで管理。認証方式は後で差し替え可能（外部IDや社員番号などを列追加できる余地を残す）。
* **日報の表現**: `daily_reports` エンティティに集約。ユーザーとは外部キーで関連付ける。
* **一意性**: 「同一ユーザーの同一日の日報は1件」を **DB制約で保証** する（アプリ側の実装ミスをカバー）。
* **拡張余地**: UI未確定の可変項目は当面は柔軟フィールド（例: 詳細情報の集合）で吸収。検索・集計・制約の必要性が見えたら子エンティティに正規化する。
* **正規化の判断基準**（該当が増えたら分割）:

  * その項目で検索/集計が増える
  * 一意性や外部参照の制約を掛けたい
  * 配列/リストが大きくなり、個別 CRUD が必要
  * 画面・APIの再利用が増える

### データ量とストレージの概算（参考）

前提（例）: 300名の社員が毎日日報を投稿する想定  
- 年間行数: 300名 × 365日 = 109,500件/年

見積り方針: 「本文＋可変details(JSONB)」の実データサイズに索引などのオーバーヘッドを考慮して概ね ×2 を掛けた概算値を使用。

| 1レポート平均（本文+JSON） | 年間データ（索引込み） | 3年 | 5年 | 7年 |
|---:|---:|---:|---:|---:|
| 軽い: 約3KB | 約0.6 GB/年 | 約1.8 GB | 約3.0 GB | 約4.2 GB |
| 普通: 約5KB | 約1.1 GB/年 | 約3.3 GB | 約5.5 GB | 約7.7 GB |
| 重い: 約10KB | 約2.1 GB/年 | 約6.3 GB | 約10.5 GB | 約14.7 GB |
| かなり重い: 約20KB | 約4.2 GB/年 | 約12.6 GB | 約21.0 GB | 約29.4 GB |

注記:
* 上表はあくまで概算。実運用では添付ファイル、長文テキスト、詳細なJSON構造などで変動する。
* 本番設計ではパーティショニング、アーカイブポリシー、読み取り専用レプリカ等を検討し、運用コストと性能要件に合わせて調整する。
* 保持方針（例えば直近2年をホット領域、それ以前をアーカイブ）を決めることが早期段階で重要。

---

## 4. API方針（契約の枠組みのみ）

* **バージョニング**: ベースパス `/v1` を固定。破壊的変更は `/v2` 新設。EoL は事前告知。
* **最初の公開面**: READ 用の一覧 API（ユーザー・日付／期間でのフィルタ）。
* **入力検証**: 日付キーが妥当であること（未来日を許容するか否かはチームで決める）。
* **認証**: 本フェーズでは未実装。ローカル/社内ネットワーク範囲でアクセスを限定。
* **詳細化のタイミング**: 本番前に OpenAPI で契約を固定し、自動テストの雛形を生成する。

---

## 5. 開発運用・ディレクトリ方針（抜粋）

* **コンテナ**: `api`（FastAPI）と `db`（PostgreSQL）を Compose で管理。必要に応じて DB GUI（Adminer など）を追加。
* **データ投入**: ダミーデータは CSV を前提とし、ステージング投入→本テーブル反映の 2 段階手順を採用（再実行でやり直し容易）。
* **責務分離**: DB エンティティ（ドメイン）と API レスポンス（DTO）は分離。整形・集約はサービス層で行う。
* **レビュー**: スキーマ変更（DDL）は PR レビュー必須。命名規約の逸脱や制約の不足をチェック。

---

## 6. 現在この範囲を実装する理由（なぜ今これだけやるか）

* **早期に“動く足場”を得る**: UIや認証が未確定でも、DB構造と読み取り API を先に動かすことで、データの粒度・現実の使い勝手をチームで評価できる。
* **将来のやり直しコストを抑える**: 「1ユーザー×1日＝1件」「UTC 保存」「命名規約」といった土台は後からの変更コストが大きいため、今のうちに固定しておく。
* **拡張への余白を残す**: 可変項目は柔軟フィールドに逃し、正規化や認証の方式は本番前に最適解を選ぶ。これによりアジャイルに合わせて段階的に品質を高められる。

---

## 7. みんなで今後決めるべきこと（ディスカッション項目）

1. **認証・認可方式**: 社内 SSO（OIDC/SAML）／短命 JWT＋リフレッシュ／セッション Cookie のいずれか。運用負荷・クライアント種別（モバイル/社内Web）を踏まえて決定。
2. **正規化の深さ**: どの可変項目を子エンティティ化するか（タグ、日別作業ログ、工数、プロジェクト紐付け等）。
3. **検索・集計要件**: 部門・プロジェクト・日付/期間の集計軸、ダッシュボードの前提（ビュー／マテビューの採用可否）。
4. **権限モデル（RBAC）**: 本人／上長／管理者の閲覧・操作範囲。将来の監査要件との整合。
5. **運用・SLO**: 目標レイテンシ、可用性、バックアップ（RPO/RTO）、監視・アラートの初期設定。
6. **データ保持/削除方針**: 退職者データの扱い、保持期間、エクスポート要件。
7. **セキュリティ境界**: 社内ネットワークの前提、TLS 終端、CORS ポリシー、秘密情報の保護（環境変数/シークレット管理）。
8. **本番スケーラビリティ**:今は学習・検証のため、本番ではスケーラビリティを考慮した設計に変更

---

## 8. 受け入れ条件（この指示書の完了定義）

* Compose で API/DB が起動・停止できる運用手順が共有されている。
* ダミーデータ投入手順がドキュメント化され、再実行可能（やり直し可）。
* READ 専用 API でユーザー・日付/期間のフィルタが通ることを確認できる。
* 「1ユーザー×1日＝1件」の整合性がサーバ側・DB側で守られる。

---

## 9. ロードマップ（短期）

* **Sprint 1（今）**: Compose 起動、ダミーデータ投入、READ API の公開。
* **Sprint 2**: 作成/更新/削除の最小 API、入力バリデーションの追加、マイグレーション運用の整備。
* **Sprint 3**: OpenAPI v1 契約の固定、ページネーションの見直し（カーソル化検討）、ログ/メトリクスの追加。
* **本番前ゲート**: 認証・認可方式の決定、正規化の最終化、RBAC と監査、TLS/CORS の有効化。

---

## 10. 連絡・レビュー方法

* 作業ブランチ命名例:
* PR テンプレートに「スキーマ変更の有無」「後方互換性」「ロールバック方法」を必須項目として記載。
